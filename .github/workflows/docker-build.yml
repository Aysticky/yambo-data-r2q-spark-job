name: Docker - Build and Push

on:
  push:
    branches: [develop, main]
    paths:
      - 'src/**'
      - 'docker/**'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Environment to build for'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: eu-central-1

jobs:
  build-and-push-dev:
    name: Build and Push to Dev ECR
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/yambo-dev-spark-job
          tags: |
            type=sha,prefix=v1.0.,format=short
            type=raw,value=latest
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push to Dev ECR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
      
      - name: Upload manifests to S3
        run: |
          aws s3 cp k8s/spark-application-extract.yaml s3://yambo-dev-manifests/spark-jobs/yambo-extract-job.yaml
          aws s3 cp k8s/spark-application-check.yaml s3://yambo-dev-manifests/spark-jobs/yambo-check-job.yaml
      
      - name: Image digest
        run: echo "Image pushed with tags ${{ steps.meta.outputs.tags }}"

  build-and-push-prod:
    name: Build and Push to Prod ECR
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/yambo-prod-spark-job
          tags: |
            type=sha,prefix=v1.0.,format=short
            type=raw,value=latest
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push to Prod ECR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
      
      - name: Upload manifests to S3
        run: |
          aws s3 cp k8s/spark-application-extract.yaml s3://yambo-prod-manifests/spark-jobs/yambo-extract-job.yaml
          aws s3 cp k8s/spark-application-check.yaml s3://yambo-prod-manifests/spark-jobs/yambo-check-job.yaml
      
      - name: Image digest
        run: echo "Image pushed with tags ${{ steps.meta.outputs.tags }}"
